"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2751],{3905:function(e,t,o){o.d(t,{Zo:function(){return u},kt:function(){return m}});var n=o(7294);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var s=n.createContext({}),c=function(e){var t=n.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},u=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(o),m=r,y=d["".concat(s,".").concat(m)]||d[m]||p[m]||a;return o?n.createElement(y,i(i({ref:t},u),{},{components:o})):n.createElement(y,i({ref:t},u))}));function m(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,i=new Array(a);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<a;c++)i[c]=o[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}d.displayName="MDXCreateElement"},800:function(e,t,o){o.r(t),o.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var n=o(7462),r=o(3366),a=(o(7294),o(3905)),i=["components"],l={id:"home-access-only",title:"How to only allow access to your server from inside your home network?",sidebar_label:"Home access only"},s=void 0,c={unversionedId:"home-access-only",id:"home-access-only",title:"How to only allow access to your server from inside your home network?",description:"In order to make your server as secure as possible, you might consider blocking all access from outside your home network. To be able to connect to your server yourself from outside your home network afterwards, you'll need to establish a VPN connection to your home network first before you can access your server. We've implemented the whole process in a way that automatic certificate renewal via Let's Encrypt will still work after blocking the access to your server which is usually a limitation of this process but not by following this guide. Additionally, scan.nexcloud.com will still be able to scan your Nextcloud regarding security problems as well as observatory.mozilla.org.",source:"@site/docs/home-access-only.md",sourceDirName:".",slug:"/home-access-only",permalink:"/Nextcloud-NAS-Guide/docs/home-access-only",draft:!1,editUrl:"https://github.com/szaimen/Nextcloud-NAS-Guide/edit/main/docs/home-access-only.md",tags:[],version:"current",frontMatter:{id:"home-access-only",title:"How to only allow access to your server from inside your home network?",sidebar_label:"Home access only"},sidebar:"docs",previous:{title:"Change update time",permalink:"/Nextcloud-NAS-Guide/docs/change-update-time"},next:{title:"Create Backup manually",permalink:"/Nextcloud-NAS-Guide/docs/manual-backup"}},u={},p=[{value:"Preparations",id:"preparations",level:2},{value:"Execution",id:"execution",level:2},{value:"What to do now?",id:"what-to-do-now",level:2},{value:"OnlyOffice",id:"onlyoffice",level:3}],d={toc:p};function m(e){var t=e.components,o=(0,r.Z)(e,i);return(0,a.kt)("wrapper",(0,n.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"In order to make your server as secure as possible, you might consider blocking all access from outside your home network. To be able to connect to your server yourself from outside your home network afterwards, you'll need to establish a VPN connection to your home network first before you can access your server. We've implemented the whole process in a way that automatic certificate renewal via ",(0,a.kt)("inlineCode",{parentName:"p"},"Let's Encrypt")," will still work after blocking the access to your server which is usually a limitation of this process but not by following this guide. Additionally, ",(0,a.kt)("inlineCode",{parentName:"p"},"scan.nexcloud.com")," will still be able to scan your Nextcloud regarding security problems as well as ",(0,a.kt)("inlineCode",{parentName:"p"},"observatory.mozilla.org"),"."),(0,a.kt)("h2",{id:"preparations"},"Preparations"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Install Pi-hole (",(0,a.kt)("a",{parentName:"li",href:"./pi-hole"},"instructions"),")",(0,a.kt)("admonition",{parentName:"li",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"To make this solution work, you will need to make the Pi-hole to the DNS server of your home network as instructed ",(0,a.kt)("a",{parentName:"p",href:"./pi-hole#what-to-do-now"},"here")))),(0,a.kt)("li",{parentName:"ol"},"Install PiVPN (",(0,a.kt)("a",{parentName:"li",href:"./pivpn"},"instructions"),")",(0,a.kt)("admonition",{parentName:"li",type:"info"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"While installing PiVPN, it is crutial that you've opted for setting Pi-hole as DNS-server for PiVPN! (step 9)"),(0,a.kt)("li",{parentName:"ul"},"All devices that shall get access to your server from outside your home network need a VPN profile. It is advices how to create and import one ",(0,a.kt)("a",{parentName:"li",href:"./pivpn#what-to-do-now"},"here and below")))))),(0,a.kt)("h2",{id:"execution"},"Execution"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Open the Apache conf file via CLI by running:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"sudo nano /etc/apache2/apache2.conf\n"))),(0,a.kt)("li",{parentName:"ol"},"Scroll to the bottom of the file by using the ",(0,a.kt)("inlineCode",{parentName:"li"},"[ARROW]")," keys and look for a line that looks like this:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"  Allow from env=AllowCountryOrContinent\n"))),(0,a.kt)("li",{parentName:"ol"},"Comment the line so that it looks like this afterwards:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"  #Allow from env=AllowCountryOrContinent\n"))),(0,a.kt)("li",{parentName:"ol"},"Safe the file by pressing ",(0,a.kt)("inlineCode",{parentName:"li"},"[CTRL] + [o]")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"[ENTER]")," and close it by pressing ",(0,a.kt)("inlineCode",{parentName:"li"},"[CTRL] + [x]")),(0,a.kt)("li",{parentName:"ol"},"Restart Apache to accept the new config by running:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"sudo systemctl restart apache2\n")))),(0,a.kt)("p",null,"This is basically it. Now all access from outside your home network will be blocked!"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"All ports that you've opened in your router until now that point to your server need to stay open. Otherwise certificate renewal via ",(0,a.kt)("inlineCode",{parentName:"p"},"Let's Encrypt")," will not work anymore and it could produce unexpected other issues. ")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Don't reinstall Geoblocking after applying this change because it will reset the configuration that you've just made.")),(0,a.kt)("h2",{id:"what-to-do-now"},"What to do now?"),(0,a.kt)("p",null,"If you've set up any service that needs its own domain, like e.g. OnlyOffice, High-Performance backend for Nextcloud Talk, Pico CMS or Vaultwarden, you need to add all of those as ",(0,a.kt)("inlineCode",{parentName:"p"},"Local DNS Records")," to your Pi-hole configuration. Otherwise you will not be able to use those services.\nA custom entry may look like this: ",(0,a.kt)("inlineCode",{parentName:"p"},"Domain: talk.yourdomain.com, IP Address: 192.168.178.144"),". You will need to add one entry for every domain and enter as IP-address the internal IP-address of your server for all of them."),(0,a.kt)("h3",{id:"onlyoffice"},"OnlyOffice"),(0,a.kt)("p",null,"If you've installed OnlyOffice Documentserver for your Nextcloud, you might still not be able to open Office files in your Nextcloud after applying above mentioned changes. This is because the docker service where the Documentserver is running on, is usually not using the local DNS server. To make this work you'll need to:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Open the docker daemon config file by running:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"sudo nano /etc/docker/daemon.json\n")),"It should look something like this:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "storage-driver": "overlay2"\n}\n'))),(0,a.kt)("li",{parentName:"ol"},"Edit the file so that it uses your local DNS server (you'll need to use the internal IP-address of your own server here instead of ",(0,a.kt)("inlineCode",{parentName:"li"},"192.168.178.144")," and please don't forget to add the comma at the end of the ",(0,a.kt)("inlineCode",{parentName:"li"},"storage-driver")," line). It should look something like this after applying the change:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "storage-driver": "overlay2",\n  "dns": ["192.168.178.144"]\n}\n'))),(0,a.kt)("li",{parentName:"ol"},"Safe the file by pressing ",(0,a.kt)("inlineCode",{parentName:"li"},"[CTRL] + [o]")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"[ENTER]")," and close it by pressing ",(0,a.kt)("inlineCode",{parentName:"li"},"[CTRL] + [x]")),(0,a.kt)("li",{parentName:"ol"},"Restart the docker daemon by running:",(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"sudo systemctl restart docker\n")))),(0,a.kt)("p",null,"Now, finally everything should work as expected!"))}m.isMDXComponent=!0}}]);